<!DOCTYPE html><html lang="Zh-tw"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> kubernetes | Install · PickOneFish's Blog</title><meta name="description" content="kubernetes | Install - PickOneFish"><meta name="keywords" content="Nebular,akveo/Nebular,ngx-admin,Smart-On-FHIR,Angular,FHIR"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://pickonefish.github.io/atom.xml" title="PickOneFish's Blog"><link rel="search" type="application/opensearchdescription+xml" href="https://pickonefish.github.io/search.xml" title="PickOneFish's Blog"><link rel="search" type="application/opensearchdescription+xml" href="https://pickonefish.github.io/sitemap.xml" title="PickOneFish's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about-me/" target="_self" class="nav-list-link">關於我</a></li><li class="nav-list-item"><a href="/about-me/index-en.html" target="_self" class="nav-list-link">ABOUTME</a></li><li class="nav-list-item"><a href="https://github.com/pickonefish" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><h1 class="post-title">kubernetes | Install</h1><div class="post"><article class="post-block"><div class="post-info">2020/06/20</div><div class="post-content"><h2 id="Folders"><a href="#Folders" class="headerlink" title="Folders"></a>Folders</h2><p>/etc/kubernetes/</p>
<h2 id="set-hosts"><a href="#set-hosts" class="headerlink" title="set hosts"></a>set hosts</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ nano /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.1.58 master-node</span><br><span class="line">192.168.1.59 node-1 worker-node-1</span><br><span class="line">192.168.1.60 node-2 worker-node-2</span><br></pre></td></tr></table></figure>
<h2 id="Uninstall-Older-Version"><a href="#Uninstall-Older-Version" class="headerlink" title="Uninstall Older Version"></a>Uninstall Older Version</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum  -y remove  docker-common docker container-selinux docker-selinux docker-engine</span><br></pre></td></tr></table></figure>
<h2 id="Install-Dependent-Packages"><a href="#Install-Dependent-Packages" class="headerlink" title="Install Dependent Packages"></a>Install Dependent Packages</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install lvm2 device-mapper device-mapper-persistent-data device-mapper-event device-mapper-libs device-mapper-event-libs</span><br></pre></td></tr></table></figure>
<h2 id="Add-Docker-Repository"><a href="#Add-Docker-Repository" class="headerlink" title="Add Docker Repository"></a>Add Docker Repository</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://download.docker.com/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>
<h2 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install docker-ce --nobest</span><br></pre></td></tr></table></figure>
<h2 id="start-the-Docker-service"><a href="#start-the-Docker-service" class="headerlink" title="start the Docker service"></a>start the Docker service</h2><p>Now you have Docker installed onto your machine, start the Docker service in case if it is not started automatically after the installation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl start docker</span><br><span class="line"></span><br><span class="line">$ systemctl enable docker</span><br></pre></td></tr></table></figure>
<h2 id="Check-the-Docker-service"><a href="#Check-the-Docker-service" class="headerlink" title="Check the Docker service."></a>Check the Docker service.</h2><p>Check the Docker service.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status docker</span><br></pre></td></tr></table></figure>
<h2 id="add-user-for-kube"><a href="#add-user-for-kube" class="headerlink" title="add user for kube"></a>add user for kube</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adduser kube --shell /bin/bash</span><br><span class="line">$ passwd kube</span><br></pre></td></tr></table></figure>
<h2 id="disable-firewall"><a href="#disable-firewall" class="headerlink" title="disable firewall"></a>disable firewall</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl stop firewalld &amp; systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="開始佈署叢集前確保關閉-firewall-及-selinux"><a href="#開始佈署叢集前確保關閉-firewall-及-selinux" class="headerlink" title="開始佈署叢集前確保關閉 firewall 及 selinux"></a>開始佈署叢集前確保關閉 firewall 及 selinux</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ setenforce 0</span><br><span class="line"></span><br><span class="line">$ nano /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<h1 id="Install-and-Initialize-Kubernetes-on-RedHat-8-CentOS-8"><a href="#Install-and-Initialize-Kubernetes-on-RedHat-8-CentOS-8" class="headerlink" title="Install and Initialize Kubernetes on RedHat 8 (CentOS 8)"></a>Install and Initialize Kubernetes on RedHat 8 (CentOS 8)</h1><h2 id="Add-Kubernetes-Repository"><a href="#Add-Kubernetes-Repository" class="headerlink" title="Add Kubernetes Repository"></a>Add Kubernetes Repository</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure>
<h2 id="install-the-Kubernetes-and-enable-kubelet"><a href="#install-the-Kubernetes-and-enable-kubelet" class="headerlink" title="install the Kubernetes and enable kubelet"></a>install the Kubernetes and enable kubelet</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yum list kubectl kubelet kubeadm kubernetes-cni</span><br><span class="line">$ yum install -y kubelet kubeadm kubectl kubernetes-cni --disableexcludes=kubernetes --skip-broken</span><br><span class="line"></span><br><span class="line">$ systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>
<p>## </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ nano /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line"></span><br><span class="line">$ sysctl --system</span><br></pre></td></tr></table></figure>
<p>## </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ swapoff -a</span><br><span class="line"></span><br><span class="line">$ nano /etc/fstab</span><br><span class="line"></span><br><span class="line"># /dev/mapper/cl-swap</span><br></pre></td></tr></table></figure>
<p>@master node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.1.58 --kubernetes-version stable-1.18</span><br><span class="line"></span><br><span class="line">$ cd ~</span><br><span class="line">$ mkdir .kube</span><br><span class="line">$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></p>
<h1 id="print-join-command"><a href="#print-join-command" class="headerlink" title="print join command"></a>print join command</h1><p>@master node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.1.58:6443 --token kc62m0.h380cthvmsqz9lxm     --discovery-token-ca-cert-hash sha256:0434eb6ff6fd4a88682f40c135ba3572c34a39246fae0087512739a6f87c2e4e</span><br></pre></td></tr></table></figure></p>
<h1 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/coreos/flannel:v0.12.0-amd64</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.12.0/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<h1 id="Install-Cluster-Networking-—-Overlay-Network"><a href="#Install-Cluster-Networking-—-Overlay-Network" class="headerlink" title="Install Cluster Networking — Overlay Network"></a>Install Cluster Networking — Overlay Network</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<h1 id="Drain-Pod-Hosts-—-Delete-Nodes"><a href="#Drain-Pod-Hosts-—-Delete-Nodes" class="headerlink" title="Drain Pod Hosts — Delete Nodes"></a>Drain Pod Hosts — Delete Nodes</h1><p>You might encounter some situation for some reason, you want to tear down your worker nodes. Please use the following command on master node to drain your worker nodes first.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</span><br><span class="line">$ kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure></p>
<p>Then, on the worker node being removed, reset all kubeadm installed state and please don’t forget reset your iptables as well.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm reset</span><br><span class="line">$ iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br></pre></td></tr></table></figure>
<h1 id="Enable-kubectl-autocompletion"><a href="#Enable-kubectl-autocompletion" class="headerlink" title="Enable kubectl autocompletion"></a>Enable kubectl autocompletion</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install bash-completion</span><br><span class="line">$ echo &apos;source &lt;(kubectl completion bash)&apos; &gt;&gt;~/.bashrc</span><br></pre></td></tr></table></figure>
<h1 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h1><h2 id="kube-proxy-config-遺失"><a href="#kube-proxy-config-遺失" class="headerlink" title="kube-proxy config 遺失"></a>kube-proxy config 遺失</h2><p>沒有 /var/lib/kube-proxy/config.conf</p>
<h1 id="CheatSheet"><a href="#CheatSheet" class="headerlink" title="CheatSheet"></a>CheatSheet</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line">kubectl get noodes</span><br><span class="line">kubectl get pods --all-namespace</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl -n kubernetes-dashboard get secret</span><br></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://medium.com/@liau.weijie/how-to-install-docker-and-kubernetes-cluster-on-redhat-8-centos-8-f774fc071e82" target="_blank" rel="noopener">https://medium.com/@liau.weijie/how-to-install-docker-and-kubernetes-cluster-on-redhat-8-centos-8-f774fc071e82</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#enable-kubectl-autocompletion" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/tools/install-kubectl/#enable-kubectl-autocompletion</a></li>
<li><a href="https://kubernetes.feisky.xyz/introduction/101" target="_blank" rel="noopener">https://kubernetes.feisky.xyz/introduction/101</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/auth-oauth2/" class="next">PREV</a><a href="/bpmn-activities/" class="prev">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'pickonefish';
var disqus_identifier = 'kubernetes-install/';
var disqus_title = 'kubernetes | Install';
var disqus_url = 'https://pickonefish.github.io/kubernetes-install/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//pickonefish.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2022 <a href="https://pickonefish.github.io">PickOneFish</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script data-ad-client="ca-pub-6473474968216737" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-122834547-1",'auto');ga('send','pageview');</script></body></html>